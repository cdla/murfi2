<?xml version="1.0" encoding="UTF-8"?>

<!--  example configuration file for the realtime fMRI system       -->
<!--  NOTE... ':' characters are not allowed in any names or values -->
<!--  Oliver Hinds <ohinds@mit.edu> 2007-09-12                      -->

<study 
    subject="foobar"
    subjectsDir="/data/subjects"
    > </study>

<info>
  <terminal
      verbose="true"
      debug="false"
      > </terminal>
  
  <log
      filename="log/log.rtl"
      disabled="false"
      > </log>

  <errlog
      filename="log/log.rtl"
      disabled="false"
      > </errlog>
</info>

<scanner
    disabled="false"

    receiveImages="true"
    port="15000"
    saveImages="true"

    onlyReadMoco="false"
    unmosaic="false"

    receiveTriggers="false"
    triggerSync="false"
    triggerCode="83"

    tr="2.0"
    measurements="64"
    matrixSize="64"
    slices="64"

> </scanner>

<display
    image="1"
    imageWinX="300"
    imageWinY="0"
    imageWinW="1000"
    imageWinH="1000"

    posOverlayID="data.image.activation.voxel-fluctmon"
    posOverlayRoiID="active"
    negOverlayID="data.image.activation.voxel-fluctmon"
    negOverlayRoiID="deactive"
    posMaskID="data.image.mask"
    posMaskRoiID="active"
    negMaskID="data.image.mask"
    negMaskRoiID="deactive"
    posActivationSumID="data.image.activation.activation-sum"
    posActivationSumRoiID="active"
    negActivationSumID="data.image.activation.activation-sum"
    negActivationSumRoiID="deactive"
>
</display>

<socket
    host="192.168.1.5"
    port="15001"
>
</socket>

<!-- preprocessing steps -->
<preprocessor>
  <output>display</output>

  <!-- intensity normalization-->
  <module name="intensity-norm">
    <option name="makeavail">true</option>
    <option name="makecurrent">true</option>

    <option name="betMask">true</option>
    <option name="betParms">-f 0.5 -g 0 -n -m</option>
    <option name="maskScript">/home/ohinds/projects/realtime/system/scripts/make_bet_mask.sh</option>
    <output>display</output>
  </module>

  <!-- voxel-wise image intensity difference between adjacent images -->
  <module name="voxel-difference">
    <output>display</output>
    <output>log</output>
  </module>

  <!-- incrementally computed mean voxel-intensity -->
  <module name="voxel-mean">
    <option name="makeavail">true</option>
    <output>display</output>
  </module>

  <!-- incrementally computed voxel-intensity variance -->
  <module name="voxel-variance">
    <option name="makeavail">true</option>
    <output>display</output>
  </module>

  <!-- incrementally computed voxel-intensity zscore -->
  <module name="voxel-zscore" threshold="3.0">
     <output>display</output>
  </module>

  <!-- incremental GLM  -->
  <module name="accumcor">
     <output>display</output>

     <option name="condition">
        0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1
     </option>

     <option name="trends">2</option>

     <option name="saveTVol">1</option>
     <option name="saveTVolName">mask/active_t.nii</option>

     <option name="savePosAsMask">1</option>
     <option name="saveNegAsMask">1</option>
     <option name="savePosAsMaskFilename">mask/active_mask.nii</option>
     <option name="saveNegAsMaskFilename">mask/background_mask.nii</option>
  </module>

  <!-- deviation of voxel intensity from expected value  -->
  <module name="singleimcor">
     <output>display</output>

     <option name="condition">
        0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1
     </option>

     <option name="trends">2</option>
     <option name="baselineThreshold">0.00001</option>
     <option name="probThreshold">0.10</option>
     <option name="correctForMultiComps">0</option>
  </module>

  <!-- deviation of voxel intensity from expected value with no regressors -->
  <module name="fluctuationmonitor">
    <option name="makeavail">true</option>
    <output>display</output>

    <option name="makeoutput">true</option>

    <option name="trends">2</option>
    <option name="probThreshold">0.05</option>
    <option name="correctForMultiComps">0</option>

    <option name="maskSource">loadFromFile</option>
    <option name="roiID">active</option>
    <option name="maskFilename">mask/active_mask.nii</option>
    <option name="maskToDisplay">true</option>

  </module>

  <!-- sums activation within an ROI -->
  <module name="activation-sum">
    <option name="makeavail">true</option>
    <output>infoserver</output>
    <output>display</output>
    <option name="roiID">active</option>
    <option name="activationID">data.image.activation.voxel-fluctmon</option>
  </module>

  <module name="activation-sum">
    <option name="makeavail">true</option>
    <option name="roiID">background</option>
  </module>

  <!-- computed the difference in activation between two activation sums -->
  <module name="activation-sum-difference">
    <output>infoserver</output>
    <output>display</output>
    <option name="posRoiID">active</option>
    <option name="negRoiID">background</option>
  </module>

  <!--  triggers events based on absolute values of activation sums -->
  <module name="event-trigger-activation-sums">
    <output>infoserver</output>
    <output>display</output>

    <option name="monitorPos">true</option>
    <option name="posroiID">active</option>
    <option name="posThresh">0.5</option>

    <option name="monitorNeg">false</option>
    <option name="negroiID">deactive</option>
    <option name="negThresh">-0.1</option>

    <option name="afterTriggerSkipTRs">10</option>
  </module>

  <!--  triggers events based on the difference between activation sums -->
  <module name="event-trigger-activation-diff">
    <output>infoserver</output>
    <output>display</output>
    <output>data.image.activation.voxel-fluctuationmonitor</output>

    <option name="monitorPos">true</option>
    <option name="posroiID">active</option>

    <option name="monitorNeg">false</option>
    <option name="negroiID">deactive</option>

    <option name="diffThresh">0.5</option>

    <option name="initialSkipTRs">20</option>
    <option name="afterTriggerSkipTRs">20</option>
  </module>

</preprocessor>

